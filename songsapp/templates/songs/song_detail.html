{% extends 'base.html' %}

{% block title %}{{ song.title }} - Sonyc{% endblock %}

{% block content %}
    {% csrf_token %}
    <div class="song-detail">
        <div>
            <img src="{{ song.image.url }}" alt="{{ song.title }}" class="song-detail-image">
        </div>
        <div class="song-detail-info">
            <h1 class="song-detail-title">{{ song.title }}</h1>
            
            {% if song.movie_name %}
                <p class="song-detail-meta"><strong>Movie:</strong> {{ song.movie_name }}</p>
            {% endif %}
            
            <p class="song-detail-meta"><strong>Singer:</strong> {{ song.singer }}</p>
            <p class="song-detail-meta"><strong>Music Director:</strong> {{ song.music_director }}</p>
            <p class="song-detail-meta"><strong>Genre:</strong> {{ song.genre }}</p>
            
            <div class="song-detail-rating">
                <strong>Rating:</strong> 
                {% for i in "12345" %}
                    {% if forloop.counter <= song.rating %}
                        ★
                    {% else %}
                        ☆
                    {% endif %}
                {% endfor %}
            </div>

            {% if song.audio_file %}
            <div class="audio-player" style="margin: 2rem 0;">
                <audio id="audio-player" controls style="width: 100%;" data-song-id="{{ song.id }}">
                    <source src="{{ song.audio_file.url }}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </div>
            {% endif %}

            <div class="song-actions">
                <button class="btn like-btn {% if user in song.likes.all %}liked{% endif %}" data-song-id="{{ song.id }}">
                    <span class="like-icon">
                        <i class="fas fa-heart"></i>
                    </span>
                    <span class="like-text">
                        {% if user in song.likes.all %}
                            Liked
                        {% else %}
                            Like
                        {% endif %}
                    </span>
                </button>
            </div>
            
            <div>
                <a href="{% url 'songsapp:song_recommendations' song.id %}" class="btn btn-primary recommendation-btn">
                    Get Similar Songs
                </a>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 3rem;">
        <a href="{% url 'songsapp:song_list' %}" class="back-link">&larr; Back to Songs</a>
    </div>

<style>
    .song-actions {
        display: flex;
        gap: 1rem;
        margin: 2rem 0;
    }

    .like-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--navy);
        background: transparent;
        color: var(--navy);
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        overflow: hidden;
        position: relative;
    }

    .like-btn:hover {
        background: var(--navy);
        color: var(--white);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(26, 35, 126, 0.2);
    }

    .like-btn.liked {
        background: var(--navy);
        color: var(--white);
    }

    .like-icon {
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }

    .like-btn:hover .like-icon {
        transform: scale(1.2);
    }

    .like-btn.liked .like-icon {
        animation: heartBeat 0.3s ease-in-out;
    }

    @keyframes heartBeat {
        0% { transform: scale(1); }
        50% { transform: scale(1.4); }
        100% { transform: scale(1); }
    }

    .message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 2rem;
        border-radius: 8px;
        background: var(--white);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateX(120%);
        transition: transform 0.3s ease;
        z-index: 1000;
    }

    .message.show {
        transform: translateX(0);
    }

    .message.success {
        border-left: 4px solid #4caf50;
        color: #2e7d32;
    }

    .message.error {
        border-left: 4px solid #f44336;
        color: #c62828;
    }

    .audio-player {
        background: var(--gray-light);
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .audio-player audio {
        width: 100%;
        height: 40px;
        border-radius: 20px;
    }

    .audio-player audio::-webkit-media-controls-panel {
        background: var(--navy);
    }

    .audio-player audio::-webkit-media-controls-play-button {
        background-color: var(--white);
        border-radius: 50%;
    }

    .audio-player audio::-webkit-media-controls-current-time-display,
    .audio-player audio::-webkit-media-controls-time-remaining-display {
        color: var(--white);
    }

    .audio-player.playing {
        background: var(--navy);
        transition: background-color 0.3s ease;
    }

    .audio-player.playing audio::-webkit-media-controls-panel {
        background: var(--navy-light);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const audioPlayer = document.getElementById('audio-player');
    
    // Function to stop all other audio players
    function stopOtherPlayers() {
        const allPlayers = document.querySelectorAll('audio');
        allPlayers.forEach(player => {
            if (player !== audioPlayer && !player.paused) {
                player.pause();
                player.currentTime = 0;
                const playerContainer = player.closest('.audio-player');
                if (playerContainer) {
                    playerContainer.classList.remove('playing');
                }
            }
        });
    }

    // Play event listener
    if (audioPlayer) {
        audioPlayer.addEventListener('play', function() {
            stopOtherPlayers();
            const playerContainer = this.closest('.audio-player');
            if (playerContainer) {
                playerContainer.classList.add('playing');
            }
        });

        audioPlayer.addEventListener('pause', function() {
            const playerContainer = this.closest('.audio-player');
            if (playerContainer) {
                playerContainer.classList.remove('playing');
            }
        });

        audioPlayer.addEventListener('ended', function() {
            const playerContainer = this.closest('.audio-player');
            if (playerContainer) {
                playerContainer.classList.remove('playing');
            }
        });
    }

    // Like/Unlike functionality
    const likeBtn = document.querySelector('.like-btn');
    if (likeBtn) {
        likeBtn.addEventListener('click', async () => {
            const songId = likeBtn.dataset.songId;
            try {
                const response = await fetch(`/songs/${songId}/toggle-like/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const isLiked = data.liked;
                    
                    // Update button state
                    likeBtn.classList.toggle('liked');
                    likeBtn.querySelector('.like-text').textContent = isLiked ? 'Liked' : 'Like';
                    
                    // Show success message
                    const message = document.createElement('div');
                    message.className = 'message success';
                    message.textContent = isLiked ? 'Song added to your favorites!' : 'Song removed from favorites';
                    document.body.appendChild(message);
                    
                    // Trigger animation
                    setTimeout(() => message.classList.add('show'), 100);
                    setTimeout(() => {
                        message.classList.remove('show');
                        setTimeout(() => message.remove(), 300);
                    }, 3000);
                }
            } catch (error) {
                console.error('Error:', error);
                const message = document.createElement('div');
                message.className = 'message error';
                message.textContent = 'An error occurred. Please try again.';
                document.body.appendChild(message);
                
                // Trigger animation
                setTimeout(() => message.classList.add('show'), 100);
                setTimeout(() => {
                    message.classList.remove('show');
                    setTimeout(() => message.remove(), 300);
                }, 3000);
            }
        });
    }
});
</script>
{% endblock %}