{% extends 'base.html' %}

{% block title %}{{ song.title }} - Sonyc{% endblock %}

{% block content %}
    {% csrf_token %}
    <div class="song-detail">
        <div class="song-detail-image-container">
            <img src="{{ song.image.url }}" alt="{{ song.title }}" class="song-detail-image">
        </div>
        <div class="song-detail-info">
            <h1 class="song-detail-title">{{ song.title }}</h1>
            
            <div class="song-detail-meta">
                {% if song.movie_name %}
                    <div class="meta-item">
                        <i class="fas fa-film"></i>
                        <span>Movie: {{ song.movie_name }}</span>
                    </div>
                {% endif %}
                
                <div class="meta-item">
                    <i class="fas fa-microphone"></i>
                    <span>Singer: {{ song.singer }}</span>
                </div>
                
                <div class="meta-item">
                    <i class="fas fa-music"></i>
                    <span>Music Director: {{ song.music_director }}</span>
                </div>
                
                <div class="meta-item">
                    <i class="fas fa-guitar"></i>
                    <span>Genre: {{ song.genre }}</span>
                </div>
            </div>
            
            <div class="song-detail-rating">
                <i class="fas fa-star"></i>
                <span>Rating: </span>
                {% for i in "12345" %}
                    {% if forloop.counter <= song.rating %}
                        <i class="fas fa-star"></i>
                    {% else %}
                        <i class="far fa-star"></i>
                    {% endif %}
                {% endfor %}
            </div>

            {% if song.audio_file %}
            <div class="audio-player" style="margin: 2rem 0;">
                <audio id="audio-player" controls style="width: 100%;" data-song-id="{{ song.id }}">
                    <source src="{{ song.audio_file.url }}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </div>
            {% endif %}

            <div class="song-actions">
                <button class="btn like-btn {% if user in song.likes.all %}liked{% endif %}" data-song-id="{{ song.id }}">
                    <span class="like-icon">
                        <i class="fas fa-heart"></i>
                    </span>
                    <span class="like-text">
                        {% if user in song.likes.all %}
                            Liked
                        {% else %}
                            Like
                        {% endif %}
                    </span>
                </button>
            </div>
            
            <div class="recommendation-section">
                <a href="{% url 'songsapp:song_recommendations' song.id %}" class="btn btn-secondary recommendation-btn">
                    <i class="fas fa-magic"></i>
                    Get Similar Songs
                </a>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 3rem;">
        <a href="{% url 'songsapp:song_list' %}" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Back to Songs
        </a>
    </div>

<style>
    .song-detail {
        display: flex;
        gap: 3rem;
        margin-bottom: 2rem;
        background: var(--surface);
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
    }

    .song-detail-image-container {
        flex-shrink: 0;
        width: 350px;
        height: 350px;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-lg);
    }

    .song-detail-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: var(--transition);
    }

    .song-detail-image:hover {
        transform: scale(1.05);
    }

    .song-detail-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .song-detail-title {
        font-size: 2.5rem;
        color: var(--text-primary);
        font-weight: 700;
        margin: 0;
    }

    .song-detail-meta {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

    .meta-item i {
        color: var(--primary);
        font-size: 1.2rem;
        width: 24px;
    }

    .song-detail-rating {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--warning);
        font-size: 1.2rem;
    }

    .song-detail-rating i {
        color: var(--warning);
    }

    .song-actions {
        display: flex;
        gap: 1rem;
        margin: 2rem 0;
    }

    .like-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 2rem;
        border: 2px solid var(--primary);
        background: transparent;
        color: var(--primary);
        border-radius: 50px;
        font-weight: 600;
        transition: var(--transition);
        cursor: pointer;
    }

    .like-btn:hover {
        background: var(--primary);
        color: var(--surface);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .like-btn.liked {
        background: var(--primary);
        color: var(--surface);
    }

    .like-icon {
        font-size: 1.2rem;
        transition: var(--transition);
    }

    .like-btn:hover .like-icon {
        transform: scale(1.2);
    }

    .like-btn.liked .like-icon {
        animation: heartBeat 0.3s ease-in-out;
    }

    @keyframes heartBeat {
        0% { transform: scale(1); }
        50% { transform: scale(1.4); }
        100% { transform: scale(1); }
    }

    .recommendation-section {
        margin-top: 1rem;
    }

    .recommendation-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 2rem;
        font-size: 1.1rem;
    }

    .message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 2rem;
        border-radius: var(--border-radius);
        background: var(--surface);
        box-shadow: var(--shadow-lg);
        transform: translateX(120%);
        transition: var(--transition);
        z-index: 1000;
    }

    .message.show {
        transform: translateX(0);
    }

    .message.success {
        border-left: 4px solid var(--success);
        color: var(--success);
    }

    .message.error {
        border-left: 4px solid var(--error);
        color: var(--error);
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const audioPlayer = document.getElementById('audio-player');
    
    // Function to stop all other audio players
    function stopOtherPlayers() {
        const allPlayers = document.querySelectorAll('audio');
        allPlayers.forEach(player => {
            if (player !== audioPlayer && !player.paused) {
                player.pause();
                player.currentTime = 0;
                const playerContainer = player.closest('.audio-player');
                if (playerContainer) {
                    playerContainer.classList.remove('playing');
                }
            }
        });
    }

    // Play event listener
    if (audioPlayer) {
        audioPlayer.addEventListener('play', function() {
            stopOtherPlayers();
            const playerContainer = this.closest('.audio-player');
            if (playerContainer) {
                playerContainer.classList.add('playing');
            }
        });

        audioPlayer.addEventListener('pause', function() {
            const playerContainer = this.closest('.audio-player');
            if (playerContainer) {
                playerContainer.classList.remove('playing');
            }
        });

        audioPlayer.addEventListener('ended', function() {
            const playerContainer = this.closest('.audio-player');
            if (playerContainer) {
                playerContainer.classList.remove('playing');
            }
        });
    }

    // Like/Unlike functionality
    const likeBtn = document.querySelector('.like-btn');
    if (likeBtn) {
        likeBtn.addEventListener('click', async () => {
            const songId = likeBtn.dataset.songId;
            try {
                const response = await fetch(`/songs/${songId}/toggle-like/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const isLiked = data.liked;
                    
                    // Update button state
                    likeBtn.classList.toggle('liked');
                    likeBtn.querySelector('.like-text').textContent = isLiked ? 'Liked' : 'Like';
                    
                    // Show success message
                    const message = document.createElement('div');
                    message.className = 'message success';
                    message.textContent = isLiked ? 'Song added to your favorites!' : 'Song removed from favorites';
                    document.body.appendChild(message);
                    
                    // Trigger animation
                    setTimeout(() => message.classList.add('show'), 100);
                    setTimeout(() => {
                        message.classList.remove('show');
                        setTimeout(() => message.remove(), 300);
                    }, 3000);
                }
            } catch (error) {
                console.error('Error:', error);
                const message = document.createElement('div');
                message.className = 'message error';
                message.textContent = 'An error occurred. Please try again.';
                document.body.appendChild(message);
                
                // Trigger animation
                setTimeout(() => message.classList.add('show'), 100);
                setTimeout(() => {
                    message.classList.remove('show');
                    setTimeout(() => message.remove(), 300);
                }, 3000);
            }
        });
    }
});
</script>
{% endblock %}